---
version: '2.0'
duo.auth_chatops:
  description: "Only send an announcement if successfully auth'ed with Duo"

  input:
    - uuid

  output:
    auth: <% $.auth %>
    message: <% $.message %>

  tasks:
    duo_auth:
      # [235, 26]
      action: duo.auth_auth

      input:
        username: <% env().get('__actions').get('st2.action').st2_context.parent.api_user %>
        pushinfo: {"UUID": "<% $.uuid %>", "Source": "ChatOps"}

      on-success:
        - announce_success

      on-error:
        - post_failure

    announce_success:
      # [105, 128]
      action: duo.announce_success
      input:
        uuid: <% $.uuid %>

    post_failure:
      # [365, 128]
      action: chatops.post_message
      input:
        channel: <% env().get('__actions').get('st2.action').st2_context.parent.source_channel %>
        whisper: false
        message: "*auth failure:* two-factor auth attempt failed.{~}"
        user: <% env().get('__actions').get('st2.action').st2_context.parent.api_user %>
